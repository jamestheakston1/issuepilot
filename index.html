<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IssuePilot - Create GitHub Issues Instantly</title>
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'gh-primary': '#24292f',
                        'gh-blue': '#0969da',
                        'gh-bg': '#f6f8fa',
                        'gh-dark': '#1f2328',
                    }
                }
            }
        }
    </script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body {
            background-color: theme('colors.gh-bg');
            font-family: theme('fontFamily.sans');
        }
        textarea::-webkit-scrollbar {
            width: 8px;
        }
        textarea::-webkit-scrollbar-thumb {
            background-color: #d1d5db;
            border-radius: 4px;
        }
        textarea::-webkit-scrollbar-track {
            background-color: #f3f4f6;
        }
        .issue-card {
            display: flex;
            align-items: flex-start;
            padding: 16px;
            border: 1px solid #e1e4e8;
            border-radius: 8px;
            background-color: #ffffff;
            transition: box-shadow 0.15s ease-in-out;
        }
        .issue-card:hover {
            box-shadow: 0 1px 4px rgba(27, 31, 35, 0.1);
        }
    </style>
</head>
<body class="min-h-screen flex items-start justify-center p-4 sm:p-8">

    <div class="w-full max-w-2xl bg-white shadow-xl rounded-xl p-6 sm:p-10 mt-8">
        
        <header class="text-center mb-8">
            <div class="flex items-center justify-center space-x-2 text-gh-primary">
                <i data-feather="github" class="w-8 h-8 text-gh-dark"></i>
                <h1 class="text-3xl font-extrabold tracking-tight">IssuePilot</h1>
            </div>
            <p class="text-gray-500 mt-2 text-lg">Create GitHub Issues instantly using the API.</p>
        </header>

        <div id="notification-box" class="hidden p-3 mb-6 rounded-lg text-sm transition-opacity duration-300" role="alert"></div>

        <div id="auth-area" class="flex justify-center items-center mb-6 p-4 border rounded-lg bg-gh-bg">
            <div id="user-profile" class="hidden items-center space-x-3">
                <img id="user-avatar" class="w-8 h-8 rounded-full" src="" alt="User Avatar" onerror="this.onerror=null;this.src='https://placehold.co/32x32/cccccc/333333?text=User'">
                <span id="user-name" class="font-semibold text-gh-dark"></span>

                <div id="kebab-menu" class="relative ml-3 sm:ml-4">
                    <button id="kebab-button" class="p-1 rounded-full hover:bg-gray-200 transition duration-150" aria-label="Account options">
                        <i data-feather="more-vertical" class="w-5 h-5 text-gray-500"></i>
                    </button>

                    <div id="dropdown-menu" class="absolute right-0 mt-2 w-48 bg-white border border-gray-200 rounded-lg shadow-xl z-20 hidden origin-top-right">
                        <button id="delete-account-button"
                                class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 rounded-lg flex items-center space-x-2 transition duration-150">
                            <i data-feather="trash-2" class="w-4 h-4"></i>
                            <span>Delete Account</span>
                        </button>
                    </div>
                </div>
            </div>
            <button id="auth-button"
                    class="w-full sm:w-auto flex items-center justify-center space-x-2 px-4 py-2 bg-gh-blue text-white font-semibold rounded-lg shadow-md hover:bg-opacity-90 transition duration-150">
                <i data-feather="github" class="w-5 h-5"></i>
                <span id="auth-button-text">Connect with GitHub</span>
            </button>
        </div>

        <div id="loading-spinner" class="hidden text-center py-10 text-gh-blue">
            <i data-feather="loader" class="w-8 h-8 animate-spin mx-auto mb-2"></i>
            <p>Loading session...</p>
        </div>

        <div id="main-content-area" class="mt-6">
            
            <div id="issues-list-view" class="hidden space-y-4">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-gh-primary">Your IssuePilot History</h2>
                    <button id="new-issue-button"
                            class="flex items-center space-x-2 px-3 py-2 bg-gh-blue text-white font-semibold rounded-lg shadow-md hover:bg-opacity-90 transition duration-150">
                        <i data-feather="plus" class="w-5 h-5"></i>
                        <span>Create New Issue</span>
                    </button>
                </div>
                
                <div id="issues-loading" class="text-center py-6 hidden">
                    <i data-feather="loader" class="w-6 h-6 animate-spin mx-auto text-gray-500"></i>
                    <p class="text-gray-500 mt-2">Loading issues created by IssuePilot...</p>
                </div>
                
                <div id="issues-empty" class="text-center py-6 hidden">
                    <p class="text-gray-500 italic">No issues found created by IssuePilot.</p>
                </div>
                
                <div id="issues-container" class="space-y-3">
                </div>
            </div>

            <form id="issue-form" class="space-y-6 hidden">
                
                <div id="repo-input-group">
                    <label for="repo-input" class="block text-sm font-medium text-gh-primary mb-1">Repository (Owner/Name) <span class="text-red-500">*</span></label>
                    <div class="relative">
                        <input type="text" id="repo-input" placeholder="e.g., supabase/supabase" required
                               class="w-full p-3 pl-10 border border-gray-300 rounded-lg focus:ring-gh-blue focus:border-gh-blue transition duration-150"
                               aria-describedby="repo-help">
                        <i data-feather="code" class="w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        
                        <div id="repo-suggestions-container" class="absolute z-10 w-full mt-1 max-h-60 overflow-y-auto bg-white border border-gray-200 rounded-lg shadow-lg hidden">
                        </div>
                    </div>
                    <p id="repo-help" class="mt-1 text-xs text-gray-500">Format: <code>owner/repository-name</code> (must be a repo you have access to)</p>
                </div>

                <div>
                    <label for="title-input" class="block text-sm font-medium text-gh-primary mb-1">Issue Title <span class="text-red-500">*</span></label>
                    <div class="relative">
                        <input type="text" id="title-input" placeholder="A concise summary of the bug or feature" required
                               class="w-full p-3 pl-10 border border-gray-300 rounded-lg focus:ring-gh-blue focus:border-gh-blue transition duration-150">
                        <i data-feather="tag" class="w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                </div>

                <div>
                    <label for="body-input" class="block text-sm font-medium text-gh-primary mb-1">Issue Body / Description</label>
                    <div class="relative">
                        <textarea id="body-input" rows="8" placeholder="Provide context, steps to reproduce, or detailed specifications. (Markdown is supported)"
                                  class="w-full p-3 pl-3 pr-3 border border-gray-300 rounded-lg focus:ring-gh-blue focus:border-gh-blue transition duration-150"></textarea>

                        <div id="mention-suggestions-container" class="absolute z-20 w-full top-full mt-1 max-h-40 overflow-y-auto bg-white border border-gray-200 rounded-lg shadow-lg hidden">
                        </div>
                    </div>
                    <div class="mt-2 flex justify-between items-center">
                        <p class="text-xs text-gray-500">Use <code>@username</code> to mention people in the issue.</p>
                        <button type="button" id="mention-button"
                                class="flex items-center space-x-1 px-3 py-1 text-xs bg-gray-200 text-gh-dark font-semibold rounded-lg hover:bg-gray-300 transition duration-150">
                            <i data-feather="at-sign" class="w-3 h-3"></i>
                            <span>@ Insert Symbol</span>
                        </button>
                    </div>
                </div>
                
                <div class="border border-dashed border-gray-300 p-4 rounded-lg bg-gray-50">
                    <label for="image-upload" class="block text-sm font-medium text-gh-primary mb-2 flex items-center space-x-2">
                        <i data-feather="image" class="w-4 h-4 text-gh-blue"></i>
                        <span>Attach Image (Embeds as Base64 in description)</span>
                    </label>
                    <input type="file" id="image-upload" accept="image/*" class="w-full text-sm text-gray-500
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-full file:border-0
                        file:text-sm file:font-semibold
                        file:bg-gh-blue/10 file:text-gh-blue
                        hover:file:bg-gh-blue/20 transition duration-150
                    ">
                    <p class="mt-2 text-xs text-gray-500">Note: The image is converted to a large Base64 string and appended to the issue description. Max 5MB file size.</p>
                </div>

                <div>
                    <label for="labels-input" class="block text-sm font-medium text-gh-primary mb-1">Labels (e.g., bug, enhancement, priority:high)</label>
                    <div class="relative">
                        <input type="text" id="labels-input" placeholder="Comma-separated list of existing labels"
                               class="w-full p-3 pl-10 border border-gray-300 rounded-lg focus:ring-gh-blue focus:border-gh-blue transition duration-150">
                        <i data-feather="tag" class="w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                </div>

                <div>
                    <label for="assignees-input" class="block text-sm font-medium text-gh-primary mb-1">Assignees (GitHub Usernames)</label>
                    <div class="relative">
                        <input type="text" id="assignees-input" placeholder="Comma-separated list of usernames"
                               class="w-full p-3 pl-10 border border-gray-300 rounded-lg focus:ring-gh-blue focus:border-gh-blue transition duration-150">
                        <i data-feather="user-plus" class="w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                </div>

                <div>
                    <label for="milestone-input" class="block text-sm font-medium text-gh-primary mb-1">Milestone (Number ID)</label>
                    <div class="relative">
                        <input type="number" id="milestone-input" placeholder="e.g., 1 (Must be the milestone's ID number)"
                               class="w-full p-3 pl-10 border border-gray-300 rounded-lg focus:ring-gh-blue focus:border-gh-blue transition duration-150">
                        <i data-feather="flag" class="w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                    <p class="mt-1 text-xs text-gray-500">Enter the numeric ID of an existing milestone in the repository.</p>
                </div>

                <button type="submit" id="submit-button"
                        class="w-full flex items-center justify-center space-x-2 px-4 py-3 bg-gh-blue text-white font-semibold rounded-lg shadow-md hover:bg-opacity-90 transition duration-150 ease-in-out transform hover:scale-[1.005]">
                    <i data-feather="send" class="w-5 h-5"></i>
                    <span>Create Issue via API</span>
                </button>
            </form>
        </div>

        <footer class="mt-8 pt-6 border-t border-gray-100 text-center text-xs text-gray-400">
            <p>Powered by Supabase and the GitHub API.</p>
        </footer>
    </div>
    
    <video id="pip-video" src="assets/deletetutorial.mp4" style="display: none;" loop></video>
    
    <div id="pip-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full relative">
            <h3 class="text-xl font-bold mb-3 text-gh-dark flex items-center space-x-2 border-b pb-2">
                 <i data-feather="trash-2" class="w-6 h-6 text-red-600"></i>
                 <span>Confirm Account Deletion</span>
            </h3>
            <p class="text-gray-700 mb-4">You are about to revoke this app's access on GitHub and sign out.</p>
            
            <p class="text-gray-600 mb-6 font-semibold">Do you want a video tutorial to guide you through revoking access in Picture-in-Picture mode?</p>
            
            <div class="space-y-3">
                <button id="modal-yes-button" class="w-full flex items-center justify-center space-x-2 px-4 py-2 bg-gh-blue text-white font-semibold rounded-lg hover:bg-opacity-90 transition">
                    <i data-feather="monitor" class="w-5 h-5"></i>
                    <span>Yes (Recommended, PiP Tutorial)</span>
                </button>
                <button id="modal-no-button" class="w-full px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition">
                    <span>No (Open GitHub Directly)</span>
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        
        const SUPABASE_URL = 'https://syczfzloslkszzpuvcre.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN5Y3pmemxvc2xrc3p6cHV2Y3JlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2MTQwMjUsImV4cCI6MjA4MTE5MDAyNX0.vy8urIWxuwuaEYCjfHiK8X4x_bafrw';
        const APP_SIGNATURE = '<!-- Created by IssuePilot-app -->';

        const form = document.getElementById('issue-form');
        const issuesListView = document.getElementById('issues-list-view');
        const issuesContainer = document.getElementById('issues-container');
        const newIssueButton = document.getElementById('new-issue-button');
        const issuesLoading = document.getElementById('issues-loading');
        const issuesEmpty = document.getElementById('issues-empty');
        const repoInput = document.getElementById('repo-input');
        const repoSuggestionsContainer = document.getElementById('repo-suggestions-container');
        const titleInput = document.getElementById('title-input');
        const bodyInput = document.getElementById('body-input');
        const notificationBox = document.getElementById('notification-box');
        const submitButton = document.getElementById('submit-button');
        const authButton = document.getElementById('auth-button');
        const userProfile = document.getElementById('user-profile');
        const userAvatar = document.getElementById('user-avatar');
        const userName = document.getElementById('user-name');
        const loadingSpinner = document.getElementById('loading-spinner');
        const authArea = document.getElementById('auth-area');
        
        const kebabButton = document.getElementById('kebab-button');
        const dropdownMenu = document.getElementById('dropdown-menu');
        const deleteAccountButton = document.getElementById('delete-account-button');
        const pipVideo = document.getElementById('pip-video');
        
        const pipModal = document.getElementById('pip-modal');
        const modalYesButton = document.getElementById('modal-yes-button');
        const modalNoButton = document.getElementById('modal-no-button');
        
        const kebabMenu = document.getElementById('kebab-menu'); 
        
        const imageUpload = document.getElementById('image-upload');
        const labelsInput = document.getElementById('labels-input');
        const assigneesInput = document.getElementById('assignees-input');
        const milestoneInput = document.getElementById('milestone-input');
        
        const mentionButton = document.getElementById('mention-button');
        const mentionSuggestionsContainer = document.getElementById('mention-suggestions-container');
        let currentMentionQuery = '';
        let mentionStartIndex = -1;
        
        const GITHUB_REVOKE_URL = 'https://github.com/settings/connections/applications/Ov23lie813N9LAMIwrVR';

        let githubAccessToken = null;
        let githubUsername = null;
        const signInText = 'Connect with GitHub';

        function showNotification(message, type = 'error') {
            if (!notificationBox) {
                return;
            }

            notificationBox.textContent = message;
            notificationBox.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-yellow-100', 'text-yellow-700');
            
            if (type === 'success') {
                notificationBox.classList.add('bg-green-100', 'text-green-700');
            } else if (type === 'warning') {
                notificationBox.classList.add('bg-yellow-100', 'text-yellow-700');
            } else {
                notificationBox.classList.add('bg-red-100', 'text-red-700');
            }

            setTimeout(() => {
                notificationBox.classList.add('hidden');
            }, 7000);
        }

        // Initialize Supabase client immediately
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        function debounce(func, timeout = 400) {
            let timer;
            return (...args) => {
                clearTimeout(timer);
                timer = setTimeout(() => { func.apply(this, args); }, timeout);
            };
        }

        function switchView(view) {
            if (view === 'list') {
                issuesListView.classList.remove('hidden');
                form.classList.add('hidden');
            } else if (view === 'form') {
                issuesListView.classList.add('hidden');
                form.classList.remove('hidden');
            }
        }

        function handleSuggestionClick(repoFullName) {
            repoInput.value = repoFullName;
            renderRepoSuggestions([]);
        }

        function displayRepoMessage(message, type = 'info') {
            repoSuggestionsContainer.innerHTML = '';
            
            let icon = 'info';
            let bgColor = 'bg-blue-50';
            let textColor = 'text-blue-700';

            if (type === 'warning') {
                icon = 'alert-triangle';
                bgColor = 'bg-yellow-50';
                textColor = 'text-yellow-700';
            }

            const messageHtml = `
                <div class="p-3 ${bgColor} ${textColor} text-sm flex items-center rounded-lg">
                    <i data-feather="${icon}" class="w-4 h-4 mr-2 flex-shrink-0"></i>
                    <span>${message}</span>
                </div>
            `;
            repoSuggestionsContainer.insertAdjacentHTML('beforeend', messageHtml);
            repoSuggestionsContainer.classList.remove('hidden');
            feather.replace();
        }

        function renderRepoSuggestions(repos) {
            repoSuggestionsContainer.innerHTML = '';

            if (!repos || repos.length === 0) {
                repoSuggestionsContainer.classList.add('hidden');
                return;
            }

            repos.forEach(repo => {
                const item = document.createElement('div');
                const repoFullName = repo.full_name;
                
                item.className = 'p-3 cursor-pointer hover:bg-gray-100 transition duration-100 border-b border-gray-100 last:border-b-0 flex items-center justify-between';
                item.innerHTML = `
                    <div>
                        <span class="font-medium text-gh-primary">${repoFullName}</span>
                        <span class="text-xs text-gray-500 block">${repo.description ? repo.description.substring(0, 50) + '...' : 'No description'}</span>
                    </div>
                    <i data-feather="star" class="w-4 h-4 text-yellow-500 ml-2"></i>
                `;
                item.addEventListener('mousedown', (e) => {
                    e.preventDefault(); 
                    handleSuggestionClick(repoFullName);
                });
                repoSuggestionsContainer.appendChild(item);
            });

            repoSuggestionsContainer.classList.remove('hidden');
            feather.replace();
        }

        async function fetchRepoSuggestions(query) {
            if (query.length < 3) return;

            if (!githubAccessToken) {
                displayRepoMessage('Please sign in to search for repositories and improve rate limits.', 'warning');
                return;
            }

            displayRepoMessage('Searching repositories...', 'info');

            const searchQuery = `${query} in:full_name,description`;
            const apiUrl = `https://api.github.com/search/repositories?q=${encodeURIComponent(searchQuery)}&per_page=7`;
            
            try {
                const headers = { 'Accept': 'application/vnd.github.v3+json' };
                if (githubAccessToken) {
                    headers['Authorization'] = `Bearer ${githubAccessToken}`;
                }
                
                const response = await fetch(apiUrl, { headers });
                const data = await response.json();

                if (response.ok && data.items) {
                    if (data.items.length > 0) {
                        renderRepoSuggestions(data.items);
                    } else {
                        displayRepoMessage(`No results found for "${query}"`, 'info');
                    }
                } else {
                    let errorMessage = data.message || `Failed to fetch repository suggestions. Status: ${response.status}`;
                    if (response.status === 403 && data.message && data.message.includes('rate limit')) {
                         errorMessage = 'Rate limit exceeded for repository search. Please try again soon or sign in.';
                    } else if (response.status === 401) {
                        errorMessage = 'Authentication failed for repository search. Please sign in again.';
                    }
                    showNotification(errorMessage, 'warning');
                    renderRepoSuggestions(null);
                }
            } catch (error) {
                renderRepoSuggestions(null);
            }
        }
        
        const debouncedFetchRepos = debounce((query) => {
            fetchRepoSuggestions(query);
        }, 400);

        function renderIssues(issues) {
            issuesContainer.innerHTML = '';
            issuesLoading.classList.add('hidden');
            issuesEmpty.classList.add('hidden');

            if (!issues || issues.length === 0) {
                issuesEmpty.classList.remove('hidden');
                return;
            }

            issues.forEach(issue => {
                const stateColor = issue.state === 'open' ? 'text-green-500' : 'text-red-500';
                const stateIcon = issue.state === 'open' ? 'circle' : 'check-circle';
                const repoPath = issue.repository_url.split('/').slice(-2).join('/');
                const date = new Date(issue.created_at).toLocaleDateString();

                const issueHtml = `
                    <a href="${issue.html_url}" target="_blank" class="issue-card block">
                        <div class="flex-shrink-0 mr-4">
                            <i data-feather="${stateIcon}" class="w-4 h-4 ${stateColor}"></i>
                        </div>
                        <div class="flex-grow">
                            <p class="text-sm text-gray-500 mb-1">
                                <span class="font-mono text-xs text-gray-600 bg-gray-100 px-2 py-0.5 rounded-full">${repoPath}</span>
                                created on ${date}
                            </p>
                            <h3 class="text-lg font-semibold text-gh-primary hover:text-gh-blue transition-colors duration-150">${issue.title}</h3>
                            <p class="text-sm text-gray-500 mt-1">#${issue.number} ${issue.state}</p>
                        </div>
                    </a>
                `;
                issuesContainer.insertAdjacentHTML('beforeend', issueHtml);
            });
            feather.replace();
        }

        async function fetchUserIssues(username) {
            if (!username || !githubAccessToken) return;

            issuesContainer.innerHTML = '';
            issuesEmpty.classList.add('hidden');
            issuesLoading.classList.remove('hidden');
            feather.replace();

            const query = `author:${username} is:issue state:all in:body "${APP_SIGNATURE}"`; 
            const apiUrl = `https://api.github.com/search/issues?q=${encodeURIComponent(query)}&sort=updated&order=desc`;
            
            try {
                const response = await fetch(apiUrl, {
                    headers: {
                        'Authorization': `Bearer ${githubAccessToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    renderIssues(data.items);
                } else {
                    const errorData = await response.json();
                    showNotification(`Failed to fetch issues: ${errorData.message || response.statusText}`, 'error');
                    renderIssues(null); 
                }
            } catch (error) {
                showNotification('Network error while fetching issues.', 'error');
                renderIssues(null);
            } finally {
                issuesLoading.classList.add('hidden');
            }
        }

        function updateUI(session) {
            loadingSpinner.classList.add('hidden');

            if (session && session.provider_token) {
                githubAccessToken = session.provider_token;
                
                const user = session.user;
                const userMetadata = user.user_metadata || {};
                githubUsername = userMetadata.user_name;

                authArea.classList.remove('justify-center');
                authArea.classList.add('justify-between');
                
                userProfile.classList.remove('hidden');
                userProfile.classList.add('flex');
                
                userName.textContent = githubUsername || user.email || 'GitHub User';
                userAvatar.src = userMetadata.avatar_url || 'https://placehold.co/32x32/cccccc/333333?text=U';
                
                authButton.textContent = 'Sign Out';
                authButton.classList.remove('bg-red-500');
                authButton.classList.add('bg-gh-blue', 'sm:text-white'); 
                
                kebabButton.classList.remove('hidden');

                showNotification(`Logged in as ${userName.textContent}. Loading your issue history...`, 'success');
                
                switchView('list');
                fetchUserIssues(githubUsername);


            } else {
                githubAccessToken = null;
                githubUsername = null;

                authArea.classList.remove('justify-between');
                authArea.classList.add('justify-center');

                userProfile.classList.add('hidden');
                userProfile.classList.remove('flex');
                issuesListView.classList.add('hidden');
                form.classList.add('hidden');
                
                authButton.innerHTML = `<i data-feather="github" class="w-5 h-5"></i><span id="auth-button-text">${signInText}</span>`;
                authButton.classList.remove('bg-red-500');
                authButton.classList.add('bg-gh-blue');
                
                dropdownMenu.classList.add('hidden');
                
                showNotification('Please sign in with GitHub to create issues via the API.', 'warning');
            }
            feather.replace();
        }

        async function signInWithGitHub() {
            const { error } = await supabase.auth.signInWithOAuth({
                provider: 'github',
                options: {
                    scopes: 'public_repo, write:issue', 
                }
            });

            if (error) {
                showNotification(`Sign In Failed: ${error.message}`, 'error');
            }
        }

        async function signOut() {
            dropdownMenu.classList.add('hidden');

            const { error } = await supabase.auth.signOut();
            if (error) {
                showNotification(`Sign Out Failed: ${error.message}`, 'error');
            } else {
                updateUI(null);
            }
        }
        
        function handleDeleteAccount() {
            dropdownMenu.classList.add('hidden');
            pipModal.classList.remove('hidden');
        }

        async function handleModalYes() {
            pipModal.classList.add('hidden');

            if ('pictureInPictureEnabled' in document && pipVideo) {
                try {
                    pipVideo.muted = true;
                    await pipVideo.play(); 
                    await pipVideo.requestPictureInPicture();
                    showNotification('Video tutorial requested. Please grant Picture-in-Picture permission (near address bar).', 'warning');

                    setTimeout(async () => {
                        window.open(GITHUB_REVOKE_URL, '_blank');
                        showNotification('GitHub settings opened in new tab. Follow the video guide.', 'warning');
                        await signOut();
                    }, 1000); 

                } catch (error) {
                    console.error('PiP failed or video playback was blocked:', error);
                    showNotification('Could not start Picture-in-Picture. Opening GitHub settings directly.', 'warning');
                    handleModalNo();
                }
            } else {
                showNotification('Your browser does not support Picture-in-Picture. Opening GitHub settings directly.', 'warning');
                handleModalNo();
            }
        }

        async function handleModalNo() {
            pipModal.classList.add('hidden');
            window.open(GITHUB_REVOKE_URL, '_blank');
            showNotification('GitHub settings opened in new tab. Please manually revoke access.', 'warning');
            await signOut();
        }

        function insertAtCursor(textarea, text) {
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const value = textarea.value;

            textarea.value = value.substring(0, start) + text + value.substring(end);
            
            const newCursorPosition = start + text.length;
            textarea.selectionStart = newCursorPosition;
            textarea.selectionEnd = newCursorPosition;
            textarea.focus();
        }
        
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.size > 1024 * 1024 * 5) { 
                showNotification('Image size exceeds 5MB. Please choose a smaller file.', 'error');
                imageUpload.value = ''; 
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const base64Image = e.target.result;
                const markdown = `\n\n![${file.name}](${base64Image})\n\n`;
                
                bodyInput.value += markdown;
                imageUpload.value = ''; 
                showNotification(`Image "${file.name}" converted to Base64 and appended to description.`, 'success');
            };
            reader.onerror = () => {
                showNotification('Failed to read image file.', 'error');
            };
            reader.readAsDataURL(file);
        }

        function hideMentionDropdown() {
            mentionSuggestionsContainer.classList.add('hidden');
            currentMentionQuery = '';
            mentionStartIndex = -1;
        }

        function checkMentionTrigger() {
            const value = bodyInput.value;
            const caretPos = bodyInput.selectionStart;

            const mentionRegex = /(?:\s|^)@(\w*)/g;
            let match;
            let lastMatch = null;
            
            while ((match = mentionRegex.exec(value)) !== null) {
                if (match.index + match[0].length >= caretPos) {
                    lastMatch = match;
                    break; 
                }
            }
            
            if (lastMatch) {
                const query = lastMatch[1];
                const start = lastMatch.index + lastMatch[0].indexOf('@') + 1; 
                
                if (caretPos >= start && caretPos <= start + query.length && query.length >= 3) {
                    currentMentionQuery = query;
                    mentionStartIndex = start;
                    debouncedFetchUsers(query);
                    return;
                }
            }
            
            hideMentionDropdown();
        }

        async function fetchUserSuggestions(query) {
            if (!githubAccessToken) {
                hideMentionDropdown();
                return;
            }

            const apiUrl = `https://api.github.com/search/users?q=${encodeURIComponent(query)} in:login&per_page=5`;
            
            try {
                const response = await fetch(apiUrl, {
                    headers: {
                        'Authorization': `Bearer ${githubAccessToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    renderUserSuggestions(data.items);
                } else {
                    hideMentionDropdown();
                }
            } catch (error) {
                hideMentionDropdown();
            }
        }
        
        const debouncedFetchUsers = debounce(fetchUserSuggestions, 300);

        function handleMentionSelection(username) {
            const textarea = bodyInput;
            const value = textarea.value;
            
            const mentionStart = mentionStartIndex - 1; 
            const newText = value.substring(0, mentionStart) + `@${username} ` + value.substring(textarea.selectionEnd);
            
            textarea.value = newText;
            
            const newCaretPos = mentionStart + `@${username} `.length;
            textarea.selectionStart = newCaretPos;
            textarea.selectionEnd = newCaretPos;

            hideMentionDropdown();
        }

        function renderUserSuggestions(users) {
            mentionSuggestionsContainer.innerHTML = '';

            if (!users || users.length === 0) {
                hideMentionDropdown();
                return;
            }
            
            users.forEach(user => {
                const item = document.createElement('div');
                item.className = 'p-2 cursor-pointer hover:bg-gh-blue/10 text-gh-dark transition duration-100 flex items-center space-x-2 border-b border-gray-100 last:border-b-0';
                item.innerHTML = `
                    <img src="${user.avatar_url}" class="w-6 h-6 rounded-full" alt="${user.login}" onerror="this.onerror=null;this.src='https://placehold.co/24x24/cccccc/333333?text=U'">
                    <span class="font-medium text-sm">@${user.login}</span>
                `;
                
                item.addEventListener('mousedown', (e) => {
                    e.preventDefault(); 
                    handleMentionSelection(user.login);
                });
                mentionSuggestionsContainer.appendChild(item);
            });

            mentionSuggestionsContainer.classList.remove('hidden');
        }

        async function createIssue(event) {
            event.preventDefault();
            
            if (!githubAccessToken || !githubUsername) {
                showNotification('You must be signed in to create an issue.', 'error');
                return;
            }

            const repoValue = repoInput.value.trim();
            const titleValue = titleInput.value.trim();
            let bodyValue = bodyInput.value.trim();
            
            const labelsValue = labelsInput.value.trim();
            const assigneesValue = assigneesInput.value.trim();
            const milestoneValue = milestoneInput.value.trim();
            
            if (!repoValue || !titleValue || !repoValue.includes('/')) {
                showNotification('Please fill in the repository (owner/name) and title correctly.', 'error');
                return;
            }

            const [owner, repo] = repoValue.split('/');

            submitButton.disabled = true;
            submitButton.innerHTML = `<i data-feather="loader" class="w-5 h-5 animate-spin"></i><span>Creating Issue...</span>`;
            feather.replace();

            bodyValue = bodyValue + '\n\n' + APP_SIGNATURE;

            const issueData = {
                title: titleValue,
                body: bodyValue,
            };
            
            if (labelsValue) {
                issueData.labels = labelsValue.split(',').map(label => label.trim()).filter(label => label.length > 0);
            }
            
            if (assigneesValue) {
                issueData.assignees = assigneesValue.split(',').map(assignee => assignee.trim()).filter(assignee => assignee.length > 0);
            }

            if (milestoneValue) {
                const milestoneNumber = parseInt(milestoneValue, 10);
                if (!isNaN(milestoneNumber) && milestoneNumber > 0) {
                    issueData.milestone = milestoneNumber;
                } else {
                     showNotification('Milestone ID must be a positive number. Skipping Milestone field.', 'warning');
                }
            }

            const apiUrl = `https://api.github.com/repos/${owner}/${repo}/issues`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${githubAccessToken}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify(issueData)
                });

                const data = await response.json();

                if (response.ok) {
                    showNotification(`Issue #${data.number} created successfully in ${repoValue}! Now showing history.`, 'success');
                    
                    titleInput.value = '';
                    bodyInput.value = '';
                    labelsInput.value = '';
                    assigneesInput.value = '';
                    milestoneInput.value = '';
                    
                    switchView('list');
                    fetchUserIssues(githubUsername);
                    
                } else {
                    let errorMessage = data.message || `Failed to create issue. Status: ${response.status}`;
                    if (data.documentation_url) {
                        errorMessage += ` Check logs for details.`;
                    }
                    showNotification(errorMessage, 'error');
                }

            } catch (error) {
                showNotification('A network error occurred while trying to reach GitHub.', 'error');
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = `<i data-feather="send" class="w-5 h-5"></i><span>Create Issue via API</span>`;
                feather.replace();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            feather.replace();
            loadingSpinner.classList.remove('hidden');

            authButton.addEventListener('click', () => {
                if (githubAccessToken) {
                    signOut();
                } else {
                    signInWithGitHub();
                }
            });

            kebabButton.addEventListener('click', (e) => {
                e.stopPropagation();
                dropdownMenu.classList.toggle('hidden');
            });
            
            deleteAccountButton.addEventListener('click', handleDeleteAccount);
            modalYesButton.addEventListener('click', handleModalYes);
            modalNoButton.addEventListener('click', handleModalNo);
            
            imageUpload.addEventListener('change', handleImageUpload);

            mentionButton.addEventListener('click', () => {
                insertAtCursor(bodyInput, '@');
                bodyInput.focus(); 
            });

            bodyInput.addEventListener('input', checkMentionTrigger);
            bodyInput.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    hideMentionDropdown();
                }
            });
            bodyInput.addEventListener('blur', () => {
                setTimeout(hideMentionDropdown, 100); 
            });


            document.addEventListener('click', (e) => {
                if (kebabMenu && !kebabMenu.contains(e.target)) {
                    dropdownMenu.classList.add('hidden');
                }
            });

            newIssueButton.addEventListener('click', () => {
                switchView('form');
            });

            form.addEventListener('submit', createIssue);
            
            repoInput.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                if (query.length === 0) {
                    renderRepoSuggestions([]);
                } else if (query.length < 3) {
                    displayRepoMessage('Start typing more characters (at least 3) to search.', 'warning');
                } else {
                    debouncedFetchRepos(query);
                }
            });

            repoInput.addEventListener('blur', () => {
                setTimeout(() => {
                    repoSuggestionsContainer.classList.add('hidden');
                }, 200);
            });

            repoInput.addEventListener('focus', (e) => {
                if (repoSuggestionsContainer.children.length > 0 && e.target.value.trim().length >= 3 && repoSuggestionsContainer.children[0].classList.contains('p-3')) {
                    repoSuggestionsContainer.classList.remove('hidden');
                }
            });

            supabase.auth.getSession().then(({ data: { session } }) => {
                updateUI(session);
            });

            supabase.auth.onAuthStateChange((event, session) => {
                if (event === 'SIGNED_IN' || event === 'TOKEN_REFRESHED') {
                    updateUI(session);
                } else if (event === 'SIGNED_OUT') {
                    updateUI(null);
                }
            });
        });
    </script>
</body>
</html>
