<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IssuePilot - Create GitHub Issues Instantly</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'gh-primary': '#24292f',
                        'gh-blue': '#0969da',
                        'gh-bg': '#f6f8fa',
                        'gh-dark': '#1f2328',
                    }
                }
            }
        }
    </script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body {
            background-color: theme('colors.gh-bg');
            font-family: theme('fontFamily.sans');
        }
        textarea::-webkit-scrollbar {
            width: 8px;
        }
        textarea::-webkit-scrollbar-thumb {
            background-color: #d1d5db;
            border-radius: 4px;
        }
        textarea::-webkit-scrollbar-track {
            background-color: #f3f4f6;
        }
        .issue-card {
            display: flex;
            align-items: flex-start;
            padding: 16px;
            border: 1px solid #e1e4e8;
            border-radius: 8px;
            background-color: #ffffff;
            transition: box-shadow 0.15s ease-in-out;
        }
        .issue-card:hover {
            box-shadow: 0 1px 4px rgba(27, 31, 35, 0.1);
        }
    </style>
</head>
<body class="min-h-screen flex items-start justify-center p-4 sm:p-8">

    <div class="w-full max-w-2xl bg-white shadow-xl rounded-xl p-6 sm:p-10 mt-8">
        
        <header class="text-center mb-8">
            <div class="flex items-center justify-center space-x-2 text-gh-primary">
                <i data-feather="github" class="w-8 h-8 text-gh-dark"></i>
                <h1 class="text-3xl font-extrabold tracking-tight">IssuePilot</h1>
            </div>
            <p class="text-gray-500 mt-2 text-lg">Create GitHub Issues instantly using the API.</p>
        </header>

        <div id="notification-box" class="hidden p-3 mb-6 rounded-lg text-sm transition-opacity duration-300" role="alert"></div>

        <div id="auth-area" class="flex justify-center items-center mb-6 p-4 border rounded-lg bg-gh-bg">
            <div id="user-profile" class="hidden items-center space-x-3">
                <img id="user-avatar" class="w-8 h-8 rounded-full" src="" alt="User Avatar" onerror="this.onerror=null;this.src='https://placehold.co/32x32/cccccc/333333?text=User'">
                <span id="user-name" class="font-semibold text-gh-dark"></span>
                <button id="revoke-access-button"
                        class="hidden sm:inline-flex items-center space-x-1 ml-4 text-xs text-red-600 hover:text-red-700 bg-red-100 px-3 py-1 rounded-full font-medium transition duration-150">
                    <i data-feather="x-octagon" class="w-3 h-3"></i>
                    <span>Revoke Access & Sign Out</span>
                </button>
            </div>
            <button id="auth-button"
                    class="w-full sm:w-auto flex items-center justify-center space-x-2 px-4 py-2 bg-gh-blue text-white font-semibold rounded-lg shadow-md hover:bg-opacity-90 transition duration-150">
                <i data-feather="github" class="w-5 h-5"></i>
                <span id="auth-button-text">Connect with GitHub</span>
            </button>
        </div>

        <div id="loading-spinner" class="hidden text-center py-10 text-gh-blue">
            <i data-feather="loader" class="w-8 h-8 animate-spin mx-auto mb-2"></i>
            <p>Loading session...</p>
        </div>

        <div id="main-content-area" class="mt-6">
            
            <div id="issues-list-view" class="hidden space-y-4">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-gh-primary">Your IssuePilot History</h2>
                    <button id="new-issue-button"
                            class="flex items-center space-x-2 px-3 py-2 bg-gh-blue text-white font-semibold rounded-lg shadow-md hover:bg-opacity-90 transition duration-150">
                        <i data-feather="plus" class="w-5 h-5"></i>
                        <span>Create New Issue</span>
                    </button>
                </div>
                
                <div id="issues-loading" class="text-center py-6 hidden">
                    <i data-feather="loader" class="w-6 h-6 animate-spin mx-auto text-gray-500"></i>
                    <p class="text-gray-500 mt-2">Loading issues created by IssuePilot...</p>
                </div>
                
                <div id="issues-empty" class="text-center py-6 hidden">
                    <p class="text-gray-500 italic">No issues found created by IssuePilot.</p>
                </div>
                
                <div id="issues-container" class="space-y-3">
                </div>
            </div>

            <form id="issue-form" class="space-y-6 hidden">
                
                <div id="repo-input-group">
                    <label for="repo-input" class="block text-sm font-medium text-gh-primary mb-1">Repository (Owner/Name) <span class="text-red-500">*</span></label>
                    <div class="relative">
                        <input type="text" id="repo-input" placeholder="e.g., supabase/supabase" required
                               class="w-full p-3 pl-10 border border-gray-300 rounded-lg focus:ring-gh-blue focus:border-gh-blue transition duration-150"
                               aria-describedby="repo-help">
                        <i data-feather="code" class="w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        
                        <div id="repo-suggestions-container" class="absolute z-10 w-full mt-1 max-h-60 overflow-y-auto bg-white border border-gray-200 rounded-lg shadow-lg hidden">
                        </div>
                    </div>
                    <p id="repo-help" class="mt-1 text-xs text-gray-500">Format: <code>owner/repository-name</code> (must be a repo you have access to)</p>
                </div>

                <div>
                    <label for="title-input" class="block text-sm font-medium text-gh-primary mb-1">Issue Title <span class="text-red-500">*</span></label>
                    <div class="relative">
                        <input type="text" id="title-input" placeholder="A concise summary of the bug or feature" required
                               class="w-full p-3 pl-10 border border-gray-300 rounded-lg focus:ring-gh-blue focus:border-gh-blue transition duration-150">
                        <i data-feather="tag" class="w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                </div>

                <div>
                    <label for="body-input" class="block text-sm font-medium text-gh-primary mb-1">Issue Body / Description</label>
                    <div class="relative">
                        <textarea id="body-input" rows="8" placeholder="Provide context, steps to reproduce, or detailed specifications. (Markdown is supported)"
                                  class="w-full p-3 pl-3 pr-3 border border-gray-300 rounded-lg focus:ring-gh-blue focus:border-gh-blue transition duration-150"></textarea>
                    </div>
                </div>

                <button type="submit" id="submit-button"
                        class="w-full flex items-center justify-center space-x-2 px-4 py-3 bg-gh-blue text-white font-semibold rounded-lg shadow-md hover:bg-opacity-90 transition duration-150 ease-in-out transform hover:scale-[1.005]">
                    <i data-feather="send" class="w-5 h-5"></i>
                    <span>Create Issue via API</span>
                </button>
            </form>
        </div>

        <footer class="mt-8 pt-6 border-t border-gray-100 text-center text-xs text-gray-400">
            <p>Powered by Supabase and the GitHub API.</p>
        </footer>
    </div>

    <script type="module">
        
        const SUPABASE_URL = 'https://syczfzloslkszzpuvcre.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN5Y3pmemxvc2xrc3p6cHV2Y3JlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2MTQwMjUsImV4cCI6MjA4MTE5MDAyNX0.vy8urIWxuwuaEYCjfHiWQUyBYKDXdhGiK8X4x_bafrw';
        const APP_SIGNATURE = '<!-- Created by IssuePilot-app -->';

        const form = document.getElementById('issue-form');
        const issuesListView = document.getElementById('issues-list-view');
        const issuesContainer = document.getElementById('issues-container');
        const newIssueButton = document.getElementById('new-issue-button');
        const issuesLoading = document.getElementById('issues-loading');
        const issuesEmpty = document.getElementById('issues-empty');
        const repoInput = document.getElementById('repo-input');
        const repoSuggestionsContainer = document.getElementById('repo-suggestions-container');
        const titleInput = document.getElementById('title-input');
        const bodyInput = document.getElementById('body-input');
        const notificationBox = document.getElementById('notification-box');
        const submitButton = document.getElementById('submit-button');
        const authButton = document.getElementById('auth-button');
        const userProfile = document.getElementById('user-profile');
        const userAvatar = document.getElementById('user-avatar');
        const userName = document.getElementById('user-name');
        const loadingSpinner = document.getElementById('loading-spinner');
        const authArea = document.getElementById('auth-area');
        const revokeAccessButton = document.getElementById('revoke-access-button');
        
        let githubAccessToken = null;
        let githubUsername = null;
        const signInText = 'Connect with GitHub';

        function showNotification(message, type = 'error') {
            if (!notificationBox) {
                return;
            }

            notificationBox.textContent = message;
            notificationBox.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-yellow-100', 'text-yellow-700');
            
            if (type === 'success') {
                notificationBox.classList.add('bg-green-100', 'text-green-700');
            } else if (type === 'warning') {
                notificationBox.classList.add('bg-yellow-100', 'text-yellow-700');
            } else {
                notificationBox.classList.add('bg-red-100', 'text-red-700');
            }

            setTimeout(() => {
                notificationBox.classList.add('hidden');
            }, 7000);
        }

        let supabase;
        try {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        } catch (e) {
            showNotification(`Setup Error: Supabase client failed to initialize.`, 'error');
        }

        function debounce(func, timeout = 400) {
            let timer;
            return (...args) => {
                clearTimeout(timer);
                timer = setTimeout(() => { func.apply(this, args); }, timeout);
            };
        }

        function switchView(view) {
            if (view === 'list') {
                issuesListView.classList.remove('hidden');
                form.classList.add('hidden');
            } else if (view === 'form') {
                issuesListView.classList.add('hidden');
                form.classList.remove('hidden');
            }
        }

        function handleSuggestionClick(repoFullName) {
            repoInput.value = repoFullName;
            renderRepoSuggestions([]);
        }

        function displayRepoMessage(message, type = 'info') {
            repoSuggestionsContainer.innerHTML = '';
            
            let icon = 'info';
            let bgColor = 'bg-blue-50';
            let textColor = 'text-blue-700';

            if (type === 'warning') {
                icon = 'alert-triangle';
                bgColor = 'bg-yellow-50';
                textColor = 'text-yellow-700';
            }

            const messageHtml = `
                <div class="p-3 ${bgColor} ${textColor} text-sm flex items-center rounded-lg">
                    <i data-feather="${icon}" class="w-4 h-4 mr-2 flex-shrink-0"></i>
                    <span>${message}</span>
                </div>
            `;
            repoSuggestionsContainer.insertAdjacentHTML('beforeend', messageHtml);
            repoSuggestionsContainer.classList.remove('hidden');
            feather.replace();
        }

        function renderRepoSuggestions(repos) {
            repoSuggestionsContainer.innerHTML = '';

            if (!repos || repos.length === 0) {
                repoSuggestionsContainer.classList.add('hidden');
                return;
            }

            repos.forEach(repo => {
                const item = document.createElement('div');
                const repoFullName = repo.full_name;
                
                item.className = 'p-3 cursor-pointer hover:bg-gray-100 transition duration-100 border-b border-gray-100 last:border-b-0 flex items-center justify-between';
                item.innerHTML = `
                    <div>
                        <span class="font-medium text-gh-primary">${repoFullName}</span>
                        <span class="text-xs text-gray-500 block">${repo.description ? repo.description.substring(0, 50) + '...' : 'No description'}</span>
                    </div>
                    <i data-feather="star" class="w-4 h-4 text-yellow-500 ml-2"></i>
                `;
                item.addEventListener('mousedown', (e) => {
                    e.preventDefault(); 
                    handleSuggestionClick(repoFullName);
                });
                repoSuggestionsContainer.appendChild(item);
            });

            repoSuggestionsContainer.classList.remove('hidden');
            feather.replace();
        }

        async function fetchRepoSuggestions(query) {
            if (query.length < 3) return;

            displayRepoMessage('Searching repositories...', 'info');

            const searchQuery = `${query} in:full_name,description`;
            const apiUrl = `https://api.github.com/search/repositories?q=${encodeURIComponent(searchQuery)}&per_page=7`;
            
            try {
                const headers = { 'Accept': 'application/vnd.github.v3+json' };
                if (githubAccessToken) {
                    headers['Authorization'] = `Bearer ${githubAccessToken}`;
                }
                
                const response = await fetch(apiUrl, { headers });
                const data = await response.json();

                if (response.ok && data.items) {
                    if (data.items.length > 0) {
                        renderRepoSuggestions(data.items);
                    } else {
                        displayRepoMessage(`No results found for "${query}"`, 'info');
                    }
                } else {
                    let errorMessage = data.message || `Failed to fetch repository suggestions. Status: ${response.status}`;
                    if (response.status === 403 && data.message && data.message.includes('rate limit')) {
                         errorMessage = 'Rate limit exceeded for repository search. Please try again soon or sign in.';
                    }
                    showNotification(errorMessage, 'warning');
                    renderRepoSuggestions(null);
                }
            } catch (error) {
                renderRepoSuggestions(null);
            }
        }
        
        const debouncedFetchRepos = debounce((query) => {
            fetchRepoSuggestions(query);
        }, 400);

        function renderIssues(issues) {
            issuesContainer.innerHTML = '';
            issuesLoading.classList.add('hidden');
            issuesEmpty.classList.add('hidden');

            if (!issues || issues.length === 0) {
                issuesEmpty.classList.remove('hidden');
                return;
            }

            issues.forEach(issue => {
                const stateColor = issue.state === 'open' ? 'text-green-500' : 'text-red-500';
                const stateIcon = issue.state === 'open' ? 'circle' : 'check-circle';
                const repoPath = issue.repository_url.split('/').slice(-2).join('/');
                const date = new Date(issue.created_at).toLocaleDateString();

                const issueHtml = `
                    <a href="${issue.html_url}" target="_blank" class="issue-card block">
                        <div class="flex-shrink-0 mr-4">
                            <i data-feather="${stateIcon}" class="w-4 h-4 ${stateColor}"></i>
                        </div>
                        <div class="flex-grow">
                            <p class="text-sm text-gray-500 mb-1">
                                <span class="font-mono text-xs text-gray-600 bg-gray-100 px-2 py-0.5 rounded-full">${repoPath}</span>
                                created on ${date}
                            </p>
                            <h3 class="text-lg font-semibold text-gh-primary hover:text-gh-blue transition-colors duration-150">${issue.title}</h3>
                            <p class="text-sm text-gray-500 mt-1">#${issue.number} ${issue.state}</p>
                        </div>
                    </a>
                `;
                issuesContainer.insertAdjacentHTML('beforeend', issueHtml);
            });
            feather.replace();
        }

        async function fetchUserIssues(username) {
            if (!username || !githubAccessToken) return;

            issuesContainer.innerHTML = '';
            issuesEmpty.classList.add('hidden');
            issuesLoading.classList.remove('hidden');
            feather.replace();

            // Query only issues created by the user and containing the app signature
            const query = `author:${username} is:issue state:all in:body "${APP_SIGNATURE}"`; 
            const apiUrl = `https://api.github.com/search/issues?q=${encodeURIComponent(query)}&sort=updated&order=desc`;
            
            console.log("Fetching issues for user:", username);
            console.log("API URL:", apiUrl);

            try {
                const response = await fetch(apiUrl, {
                    headers: {
                        'Authorization': `Bearer ${githubAccessToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    renderIssues(data.items);
                } else {
                    const errorData = await response.json();
                    console.error('GitHub API Response Error:', response.status, errorData);
                    showNotification(`Failed to fetch issues: ${errorData.message || response.statusText}`, 'error');
                    renderIssues(null); 
                }
            } catch (error) {
                showNotification('Network error while fetching issues.', 'error');
                console.error('Fetch Issues Error:', error);
                renderIssues(null);
            } finally {
                issuesLoading.classList.add('hidden');
            }
        }

        function updateUI(session) {
            loadingSpinner.classList.add('hidden');

            if (session && session.provider_token) {
                githubAccessToken = session.provider_token;
                
                const user = session.user;
                const userMetadata = user.user_metadata || {};
                githubUsername = userMetadata.user_name;

                authArea.classList.remove('justify-center');
                authArea.classList.add('justify-between');
                
                userProfile.classList.remove('hidden');
                userProfile.classList.add('flex');
                
                userName.textContent = githubUsername || user.email || 'GitHub User';
                userAvatar.src = userMetadata.avatar_url || 'https://placehold.co/32x32/cccccc/333333?text=U';
                
                authButton.textContent = 'Sign Out';
                authButton.classList.remove('bg-gh-blue');
                authButton.classList.add('bg-red-500', 'sm:bg-gh-blue', 'sm:text-white'); // Style sign out button differently for mobile/desktop
                revokeAccessButton.classList.remove('hidden');

                showNotification(`Logged in as ${userName.textContent}. Loading your issue history...`, 'success');
                
                switchView('list');
                fetchUserIssues(githubUsername);


            } else {
                githubAccessToken = null;
                githubUsername = null;

                authArea.classList.remove('justify-between');
                authArea.classList.add('justify-center');

                userProfile.classList.add('hidden');
                userProfile.classList.remove('flex');
                issuesListView.classList.add('hidden');
                form.classList.add('hidden');
                
                authButton.innerHTML = `<i data-feather="github" class="w-5 h-5"></i><span id="auth-button-text">${signInText}</span>`;
                authButton.classList.remove('bg-red-500');
                authButton.classList.add('bg-gh-blue');
                revokeAccessButton.classList.add('hidden');
                
                showNotification('Please sign in with GitHub to create issues via the API.', 'warning');
            }
            feather.replace();
        }

        async function signInWithGitHub() {
            if (!supabase) return;

            const { error } = await supabase.auth.signInWithOAuth({
                provider: 'github',
                options: {
                    scopes: 'public_repo, write:issue', 
                }
            });

            if (error) {
                showNotification(`Sign In Failed: ${error.message}`, 'error');
            }
        }

        async function signOut() {
            if (!supabase) return;
            const { error } = await supabase.auth.signOut();
            if (error) {
                showNotification(`Sign Out Failed: ${error.message}`, 'error');
            } else {
                updateUI(null);
            }
        }

        async function revokeAccessAndSignOut() {
            if (!supabase) return;

            const confirmed = window.confirm("Are you sure you want to revoke access and sign out? You will need to manually remove this application's authorization from your GitHub settings for a complete disconnect.");
            
            if (confirmed) {
                // Since there is no direct client-side delete/revoke user method,
                // we sign out and inform the user of the manual step.
                await signOut();
                showNotification('Access revoked and signed out. For a complete disconnect, please remove IssuePilot from your GitHub authorized OAuth Apps settings.', 'warning');
            }
        }

        async function createIssue(event) {
            event.preventDefault();
            
            if (!githubAccessToken || !githubUsername) {
                showNotification('You must be signed in to create an issue.', 'error');
                return;
            }

            const repoValue = repoInput.value.trim();
            const titleValue = titleInput.value.trim();
            let bodyValue = bodyInput.value.trim();
            
            if (!repoValue || !titleValue || !repoValue.includes('/')) {
                showNotification('Please fill in the repository (owner/name) and title correctly.', 'error');
                return;
            }

            const [owner, repo] = repoValue.split('/');

            submitButton.disabled = true;
            submitButton.innerHTML = `<i data-feather="loader" class="w-5 h-5 animate-spin"></i><span>Creating Issue...</span>`;
            feather.replace();

            // Append unique signature to the body
            bodyValue = bodyValue + '\n\n' + APP_SIGNATURE;

            const issueData = {
                title: titleValue,
                body: bodyValue,
            };

            const apiUrl = `https://api.github.com/repos/${owner}/${repo}/issues`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${githubAccessToken}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify(issueData)
                });

                const data = await response.json();

                if (response.ok) {
                    showNotification(`Issue #${data.number} created successfully in ${repoValue}! Now showing history.`, 'success');
                    
                    titleInput.value = '';
                    bodyInput.value = '';

                    switchView('list');
                    fetchUserIssues(githubUsername);
                    
                } else {
                    let errorMessage = data.message || `Failed to create issue. Status: ${response.status}`;
                    if (data.documentation_url) {
                        errorMessage += ` Check logs for details.`;
                    }
                    showNotification(errorMessage, 'error');
                }

            } catch (error) {
                showNotification('A network error occurred while trying to reach GitHub.', 'error');
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = `<i data-feather="send" class="w-5 h-5"></i><span>Create Issue via API</span>`;
                feather.replace();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            feather.replace();
            loadingSpinner.classList.remove('hidden');

            authButton.addEventListener('click', () => {
                if (githubAccessToken) {
                    signOut();
                } else {
                    signInWithGitHub();
                }
            });

            revokeAccessButton.addEventListener('click', revokeAccessAndSignOut);

            newIssueButton.addEventListener('click', () => {
                switchView('form');
            });

            form.addEventListener('submit', createIssue);
            
            repoInput.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                if (query.length === 0) {
                    renderRepoSuggestions([]);
                } else if (query.length < 3) {
                    displayRepoMessage('Start typing more characters (at least 3) to search.', 'warning');
                } else {
                    debouncedFetchRepos(query);
                }
            });

            repoInput.addEventListener('blur', () => {
                setTimeout(() => {
                    repoSuggestionsContainer.classList.add('hidden');
                }, 200);
            });

            repoInput.addEventListener('focus', (e) => {
                if (repoSuggestionsContainer.children.length > 0 && e.target.value.trim().length >= 3 && repoSuggestionsContainer.children[0].classList.contains('p-3')) {
                    repoSuggestionsContainer.classList.remove('hidden');
                }
            });


            if (supabase) {
                supabase.auth.getSession().then(({ data: { session } }) => {
                    updateUI(session);
                });

                supabase.auth.onAuthStateChange((event, session) => {
                    if (event === 'SIGNED_IN' || event === 'TOKEN_REFRESHED') {
                        updateUI(session);
                    } else if (event === 'SIGNED_OUT') {
                        updateUI(null);
                    }
                });
            } else {
                 loadingSpinner.classList.add('hidden');
                 updateUI(null);
            }
        });
    </script>
</body>
</html>
